
<style>	
    .ol-zoom{
        display: block;
		top: auto;
		bottom: 10px;
		left: 10px;
    }
	.ol-control button{
		background-color: #69C3A0;
		font-size: 20px;
	}
    .ol-attribution{
        display: none;
    }
    .ol-rotate{
        top: auto;
        bottom: 170px;
        right: 18px;
        display: none;
    }
</style>

<div class="panel panel-default" style="height: 150px;">
	<div class="panel-body">
		<div id="divResultado">Buscando parada...</div>
	</div>
</div>

<div class="panel panel-default">
	<div class="panel-body">
		<div id="divMapa" style="width: 100%; height: 300px;"></div>
	</div>
</div>

<script>
$('#divResultado').html('Buscando paradas...');

var param = '';
if (typeof paradaBusqueda.codcalle != 'undefined') {
	param = 'codcalle='+paradaBusqueda.codcalle;
	param += '&codcalleint='+paradaBusqueda.codcalleint;
	
	$.getJSON( urlHost+"/ws/transporteurbano/paradacercana?"+param, function( data ) {
		$('#divResultado').html('Buscando colectivo...');
		paradaBusqueda = data[0][0];
		var datosparada = obtenerDatosMostrarParada(paradaBusqueda);
		var url = urlHost+"/ws/transporteurbano/cuandollega/"+paradaBusqueda.id+'/'+paradaBusqueda.linea;
		
		$.getJSON( url, function( data ) {
			colectivoProximo = data[0];
			$('#divResultado').html(datosparada+'<br>Colectivo próximo a: '+colectivoProximo.costototal+'<br>Unidad: '+colectivoProximo.unidad_id+'<br>Ult. Actualización: '+colectivoProximo.fecha);
			
			inicializar();
		});
	});
} else if (typeof paradaBusqueda.id != 'undefined') {
	param = 'id='+paradaBusqueda.id;
	param += '&xy='+ol.proj.transform(posActual,'EPSG:3857','EPSG:4326');
	
	$.getJSON( urlHost+"/ws/transporteurbano/getparada?"+param, function( data ) {
		$('#divResultado').html('Buscando colectivo...');
		paradaBusqueda = data[0][0];
		var datosparada = obtenerDatosMostrarParada(paradaBusqueda);
		var url = urlHost+"/ws/transporteurbano/cuandollega/"+paradaBusqueda.id+'/'+paradaBusqueda.linea;
		
		$.getJSON( url, function( data ) {
			colectivoProximo = data[0];
			$('#divResultado').html(datosparada+'<br>Colectivo próximo a: '+colectivoProximo.costototal+'<br>Unidad: '+colectivoProximo.unidad_id+'<br>Ult. Actualización: '+colectivoProximo.fecha);
			
			inicializar();
		});
	});
}

/* prepara el mapa */
var map;
function inicializar(){
	$('#divMapa').css("height", ($( window ).height() - 350));
		
	osm = new ol.layer.Tile({
		id: 'base_'+1,
		preload: Infinity,
		name: 'osm',
		type: 'base',
		title: 'Open Street Map',
		visible: true,
		source: new ol.source.OSM()
	});

	var layersBases = [osm];
	cantCapasBases = layersBases.length;
	/* END crea los mapas bases */

	view = new ol.View({
		center: posActual,
		zoom: 12
	});

	map = new ol.Map({
		target: 'divMapa',		
		layers: layersBases,
		view: view
	});
	
	var layer = new ol.layer.Tile({
		type: 'overlay',
		visible: true,
		source: new ol.source.TileWMS({
			url: 'http://200.58.108.122/cgi-bin/mapserv?map=/var/www/gis/files/maps/gisar_1.map',
			gutter: 50,
			params: { 'LAYERS': 'transportelinea'+paradaBusqueda.linea }
		})
	});
	map.addLayer(layer);
	
	/**/
	featurePosActual = new ol.Feature({
		geometry: new ol.geom.Point(posActual),
		nombre: 'Mi posición'
	});

	featuresOverlay = new ol.FeatureOverlay({
		map: map,
		features: [featurePosActual]
	});
	
	var iconStyle = new ol.style.Style({
		image: new ol.style.Icon(({
			anchor: [15, 15],
			anchorXUnits: 'pixels',
			anchorYUnits: 'pixels',
			opacity: 0.75,
			src: 'iconos/miposicion.png'
		}))
	});
	
	featurePosActual.setStyle(iconStyle);
	/**/
	var format = new ol.format.WKT();
	var feature = format.readFeature(paradaBusqueda.geom_wkt);
	feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
	
	featureParada = new ol.Feature({
		geometry: feature.getGeometry(),
		nombre: 'Parada'
	});
	
	view.setCenter(feature.getGeometry().getFirstCoordinate());

	featuresOverlayParada = new ol.FeatureOverlay({
		map: map,
		features: [featureParada]
	});
	
	var iconStyle = new ol.style.Style({
		image: new ol.style.Icon(({
			anchor: [16, 30],
			anchorXUnits: 'pixels',
			anchorYUnits: 'pixels',
			opacity: 0.75,
			src: 'iconos/parada.png'
		}))
	});
	
	featureParada.setStyle(iconStyle);
	/**/
	var format = new ol.format.WKT();
	var feature = format.readFeature(colectivoProximo.geom);
	feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
	
	featureColectivo = new ol.Feature({
		geometry: feature.getGeometry(),
		nombre: 'Colectivo'
	});

	featuresOverlayColectivo = new ol.FeatureOverlay({
		map: map,
		features: [featureColectivo]
	});
	
	var iconStyle = new ol.style.Style({
		image: new ol.style.Icon(({
			anchor: [16, 16],
			anchorXUnits: 'pixels',
			anchorYUnits: 'pixels',
			opacity: 0.75,
			src: 'iconos/bus.png'
		}))
	});
	
	featureColectivo.setStyle(iconStyle);
	/**/
}
/**/


</script>