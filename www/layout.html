<!doctype html>
<html>
<head >
    <meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuándo llega?</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/ionicons.min.css" rel="stylesheet" type="text/css">
    <link href="css/font-awesome.css" rel="stylesheet" type="text/css">
    <link href="css/jAlert-v3.css" rel="stylesheet">
    <link href="css/snap.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet" type="text/css">
    <link href="css/animacion_carga.css" rel="stylesheet" type="text/css">
    <link href="js/combobox/css/select2.min.css" rel="stylesheet" type="text/css">
	<link href="js/ol3/ol.css" rel="stylesheet" type="text/css">
</head>
<body>
	<style>	
    .ol-zoom{
        display: block;
		top: auto;
		bottom: 10px;
		left: 10px;
    }
	.ol-control button{
		background-color: #69C3A0;
		font-size: 20px;
	}
    .ol-attribution{
        display: none;
    }
    .ol-rotate{
        top: auto;
        bottom: 170px;
        right: 18px;
        display: none;
    }
    
    img { display:inline;}	
	
	.snapjs-left .snap-drawers {
		display: block;
	}
	.snap-drawers {
		display: none;
		background-color:#EEEEEE;
	}
	.snap-drawer{
		background-color:#EEEEEE;
	}
    </style>
    <div id="cargando">
        <div class="sk-chasing-dots">
          <div class="sk-child sk-dot1"></div>
          <div class="sk-child sk-dot2"></div>
        </div>
    </div>
    <div id="estado_conexion">
    	<i class="fa fa-exclamation-triangle" style="margin-right: 5px; color:#D5D412;"></i>Problemas de red, verifique su conexión a internet...
    </div>
	<div class="snap-drawers">
         <div class="snap-drawer snap-drawer-left">
            <div class="col-xs-12 fondo_top" style="height:50px;">
				<div id="top_titulo" style="border-bottom: 1px solid #e5e5e5; padding: 12px;"><span>Menú de Opciones</span></div>
            </div>
            <div class="col-xs-12"  style="margin-top: 20px; margin-left:5px">
                <div class="menu_opciones" onclick="snapper.close(); $('#divContenido').load('./principal.html');"><i class="fa fa-envelope" style="margin-right: 5px;"></i>Inicio</div>
            </div>
            <div class="col-xs-12"  style="margin-top: 20px; margin-left:5px">
                <div class="menu_opciones jframe_sugerencia"><i class="fa fa-envelope" style="margin-right: 5px;"></i>Sugerencias</div>
            </div>
            <div class="col-xs-12" style="margin-top: 15px; margin-left:5px">
                <div class="menu_opciones jframe_about"><i class="fa fa-info-circle" style="margin-right: 5px;margin-left:2px"></i>About</div>
            </div>
        </div> 
    </div>    		
    <div id="contenido"  class="snap-content" style="overflow:hidden">    
        <nav class="navbar navbar-default navbar-fixed-top fondo_top">        
            <div class="container">
                <div id="do-drag" style="height: 50px;">
                    <div id="top_logo"><img src="img/logo.png" style="height: 30px; margin-top: 5px"></div>
                    <div id="btn_menu" class="sb-toggle-left top_btn_menu"><i class="fa fa-bars"></i></div>
                    <div id="top_titulo"><span>Cuándo llega?</span></div>
                </div>       
            </div>         
        </nav>
		<div style="margin-top:60px; padding:10px;" id="divContenido">
		</div>   
        <nav class="navbar navbar-default navbar-fixed-bottom">        
            <div class="container">
                <div id="do-drag" style="height: 50px; text-align:center; font-size:28px;">
                    <a onclick="snapper.close(); $('#divContenido').load('./principal.html');"><i class="fa fa-home"></i></a>
                    <a onclick="snapper.close(); $('#divContenido').load('./resultado.html');"><i class="fa fa-globe"></i></a>
                </div>       
            </div>         
        </nav>
	</div>
	<script type="text/javascript" src="cordova.js"></script>	  
    <script type="text/javascript" src="js/index.js"></script>    
    <script type="text/javascript" src="js/libs/jquery.js"></script>	
	<script type="text/javascript" src="js/ol3/ol.js"></script>	     	     
    <script type="text/javascript" src="js/libs/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/libs/jquery.touchSwipe.min.js"></script> 
	<script type="text/javascript" src="js/libs/jAlert-functions.min.js"></script>
    <script type="text/javascript" src="js/libs/jAlert-v3.min.js"></script>    
    <script type="text/javascript" src="js/libs/snap.js"></script>         
    <script type="text/javascript" src="js/combobox/js/select2.min.js"></script>   

    <script type="text/javascript">
		var urlHost = 'http://200.58.108.122/gis';
		var posActual = [-6506141.183454158, -4110246.2464916063];

		var parada = null; // id de la parada activa
		var paradaBusqueda = []; // id de la parada activa
		var colectivoProximo = []; // id de la parada activa
		
		/* PARAMETROS deben estar en 4326 */
		function puntoGPS(xparam, yparam){	
			var pos3857 = ol.proj.transform([xparam, yparam],'EPSG:4326','EPSG:3857');
			var xAnt = posActual[0];
			var yAnt = posActual[1];
			var x = pos3857[0];
			var y = pos3857[1];
			
			posActual[0] = x;
			posActual[1] = y;
			
			buscarParadaCercana();
		}

		$( document ).ready( function() { 
			//inicializar(); 
			//navigator.geolocation.getCurrentPosition(onSuccessGPS, onErrorGPS);  
			var watchID = navigator.geolocation.watchPosition(onSuccessGPS, onErrorGPS, { timeout: 3000, enableHighAccuracy: true  });
		});

		var snapper = new Snap({
			element: document.getElementById('contenido'),
			dragger: document.getElementById('do-drag'),
			disable: 'right'
		});				
		var mySlidebars;
		var jAlertSugerencias;
		app.initialize();
		(function($) {
			$(document).ready(function() {				
				$("#divContenido").load('./principal.html');
				
				verifConexion = setInterval(function() {
					verificiarConexion();	
				}, 5000);
				
				buscarParadaCercana()
				
				$('#btn_menu').click(function(e) {
					 snapper.open('left');  
				});
				
				$("#inputBusqueda").on( "keydown", function(event) {
			      if(event.which == 13) 
					realizarBusqueda();
				});
				
				$('.jframe_about').alertOnClick({
				   'iframe': 'about.html',
				   'size': 'xlg' 
				});
				$('.jframe_sugerencia').alertOnClick({
				   'iframe': 'sugerencia.html?urlHost='+urlHost,
				   'size': 'xlg',
				   'onOpen': function(alert){
						jAlertSugerencias = alert;
				   }
				});
			});
			
			
		}) (jQuery);
		
		$(function() {	
			//Enable swiping...

			$("#divInfoEntidad").swipe( {
			 //Generic swipe handler for all directions
			 swipe:function(event, direction, distance, duration, fingerCount, fingerData) {
				if(direction == "down"){
					$("#divInfoEntidadDetalle").show("slow");
					$("#marker_flecha").attr('class', 'fa fa-caret-up');
					bandera_divInfoEntidadDetalle = true;
			   }
				if(direction == "up"){
				   if(bandera_divInfoEntidadDetalle){
						$("#divInfoEntidadDetalle").hide("slow");
						$("#marker_flecha").attr('class', 'fa fa-caret-down');
						bandera_divInfoEntidadDetalle = false;		   
				   }else{
					   $("#divInfoEntidad").toggle("slow");
				   }
				   bandera_divInfoEntidadDetalle = false;
			   }		   
			 },
			 //Default is 75px, set to 0 for demo so any distance triggers swipe
			  threshold:20
			});
			
		});
		
		function buscarParada(){
			var param = '';
			$('#divBusquedaResultado').html('Buscando...');
				
			param += 'codcalle='+paradaBusqueda.codcalle;
			param += '&codcalleint='+paradaBusqueda.codcalleint;
			
			$.getJSON( urlHost+"/ws/transporteurbano/paradacercana?"+param, function( data ) {
				cuandollega(data[0][0]);
			});
		}
		
		function cuandollega(parada){		
			$('#divParadaActualizar').html('<br>Buscando...');
			
			var datosparada = obtenerDatosMostrarParada(parada);
			var url = urlHost+"/ws/transporteurbano/cuandollega/"+parada.id+'/'+parada.linea;
			
			$.getJSON( url, function( data ) {
				$('#divParada').html(datosparada);
				if (typeof data[0] != 'undefined') {
					$('#divParada').append('<br>Distancia de la unidad: '+data[0].costototal+'<br>'+data[0].geom);
				}
			});
		}
		
		function buscarParadaCercana(){
			var param = '';
			$('#divParadaActualizar').html('<br>Actualizando...');
				
			param += 'xy='+ol.proj.transform(posActual,'EPSG:3857','EPSG:4326')
			$.getJSON( urlHost+"/ws/transporteurbano/paradacercana?"+param, function( data ) {
				cuandollega(data[0][0]);
				var html = obtenerDatosMostrarParada(data[0][0]);
				$('#divParada').html(html);
				$('#divParadaActualizar').html('');
			});
			/**/
		}
		
		function obtenerDatosMostrarParada(paradaParam){
			var html = '';
			
			parada = paradaParam;
			
			if (parada.distancia >= 1000){
				html = 'Parada a '+(parada.distancia / 1000).toFixed(2)+' km.';
			} else{
				html = 'Parada a '+parseFloat(parada.distancia).toFixed(2)+' m.';
			}
			
			if (parada.lineauno == true){
				parada.linea = 1;
				html += '<br>Linea 1';
			}
			if (parada.lineados == true){
				parada.linea = 2;
				html += '<br>Linea 2';
			}
			if (parada.lineatres == true){
				parada.linea = 3;
				html += '<br>Linea 3';
			}
			if (parada.lineacuatro == true){
				parada.linea = 4;
				html += '<br>Linea 4';
			}
			if (parada.lineacinco == true){
				parada.linea = 5;
				html += '<br>Linea 5';
			}
			html += '<br>#'+parada.numero;
			
			if (parada.ubicacion != null){
				html += '<br>'+parada.ubicacion;
			}
			
			if (parada.horario != null){
				html += '<br>'+parada.horario;
			}
			
			return html;
		}
 			
    </script>	   
</body>
</html>
